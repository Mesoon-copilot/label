<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Label Print 4x1.5 (Select2)</title>

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
:root{
  --label-w: 4in;
  --label-h: 1.5in;
  --bg:#f6f7fb;
  --card:#fff;
  --border:#e5e7eb;
  --text:#111;
  --muted:#6b7280;
  --radius:16px;
  --font:"Segoe UI",Tahoma,sans-serif;
}
body{font-family:var(--font);margin:0;background:var(--bg);color:var(--text);}
.wrap{max-width:1100px;margin:18px auto;padding:0 14px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);}
h1{margin:0;font-size:18px;}
.sub{font-size:12px;color:var(--muted);margin-top:4px;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
@media(max-width:900px){.grid,.grid3{grid-template-columns:1fr;}}
label{font-size:12px;color:#374151;display:block;margin-bottom:6px;}
input,select{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:12px;font-size:14px;box-sizing:border-box;}
input[readonly]{background:#f9fafb;}
button{border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;background:#111;color:#fff;}
button.secondary{background:#e5e7eb;color:#111;}
.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center;}
.status{margin-left:auto;font-size:12px;display:flex;gap:8px;align-items:center;}
.dot{width:10px;height:10px;border-radius:999px;background:#9ca3af;}
.dot.ok{background:#22c55e;}
.dot.bad{background:#ef4444;}
.labels{display:flex;flex-wrap:wrap;padding:12px;background:#fff;border:1px dashed #d1d5db;border-radius:16px;margin-top:16px;}

.label{
  width:var(--label-w);
  height:var(--label-h);
  box-sizing:border-box;
  padding:0.15in 0.18in;
  border:1px solid #111;
  display:flex;
}
.lay{
  width:100%;
  height:100%;
  display:grid;
  grid-template-columns:1.2fr 1fr;
  grid-template-rows:auto 1fr auto;
}
.store{font-weight:900;font-size:20px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.right{text-align:right;font-weight:900;}
.right .cap{font-size:15px;}
.right .code{font-size:20px;margin-top:6px;}
.count{grid-column:1/3;text-align:center;font-weight:900;font-size:30px;align-self:center;}
.prov{grid-column:1/3;text-align:center;font-weight:900;font-size:20px;}

@media print{
 @page{size:4in 1.5in;margin:0;}
 body{margin:0;background:#fff;}
 .no-print{display:none !important;}
 .labels{display:block;padding:0;border:0;}
 .label{width:4in;height:1.5in;border:0;margin:0;page-break-after:always;}
}
</style>
</head>

<body>
<div class="wrap">
<div class="card no-print">
<h1>พิมพ์สติ๊กเกอร์ 4x1.5 นิ้ว</h1>
<div class="sub">เลือกจาก Dropdown Search (Select2)</div>

<div class="grid" style="margin-top:12px;">
<div>
<label>เลือกลูกค้า</label>
<select id="customerSelect" style="width:100%"></select>
</div>
<div class="grid3">
<div><label>รหัสสาขา</label><input id="branchCode" readonly></div>
<div><label>ชื่อร้าน</label><input id="customerName" readonly></div>
<div><label>จังหวัด</label><input id="province" readonly></div>
</div>
</div>

<div class="grid3" style="margin-top:12px;">
<div><label>จำนวนกล่องทั้งหมด</label><input id="totalBoxes" type="number" min="0" value="0"></div>
<div><label>Action</label>
<select id="action">
<option value="PRINT">PRINT</option>
<option value="REPRINT">REPRINT</option>
<option value="CANCEL">CANCEL</option>
</select></div>
<div><label>หมายเหตุ</label><input id="note"></div>
</div>

<div class="grid" style="margin-top:12px;">
<div>
<label>เลือกคนขับ</label>
<select id="driverSelect" style="width:100%"></select>
</div>
<div class="grid3">
<div><label>ทะเบียน</label><input id="driverPlate" readonly></div>
<div><label>ชื่อ</label><input id="driverName" readonly></div>
<div><label>โทร</label><input id="driverPhone" readonly></div>
</div>
</div>

<div class="btns">
<button id="btnGen">สร้างตัวอย่าง</button>
<button id="btnPrint">พิมพ์</button>
<button class="secondary" id="btnClear">ล้าง</button>
<div class="status"><div class="dot" id="apiDot"></div><span id="apiText">พร้อม</span></div>
</div>
</div>

<div class="labels" id="labels"></div>
</div>

<script>
// CONFIG (ตั้งให้แล้ว)
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbwNsX5Wj0C2tdgNw3AVQf3jxw-NNCUG0JWDWqE9uUVASXoueUemIYxuOtFDkrFFul4T/exec";
const API_TOKEN="pR1nT-LOG-20260212-TOKEN-9f3kQx";

const byId=id=>document.getElementById(id);

function setStatus(ok,msg){
const dot=byId("apiDot");
dot.className="dot "+(ok?"ok":"bad");
byId("apiText").textContent=msg;
}

function jsonpRequest(url){
return new Promise((resolve,reject)=>{
const cb="cb_"+Math.random().toString(36).slice(2);
window[cb]=data=>{delete window[cb];script.remove();resolve(data);};
const script=document.createElement("script");
script.src=url+(url.includes("?")?"&":"?")+"callback="+cb;
script.onerror=()=>reject(new Error("JSONP request failed"));
document.body.appendChild(script);
});
}

async function apiGet(op,params={}){
const qs=new URLSearchParams({op,token:API_TOKEN,...params});
const url=WEBAPP_URL+"?"+qs.toString();
const json=await jsonpRequest(url);
if(!json.ok)throw new Error(json.error||"API error");
return json;
}

let customers=[],drivers=[];

function initSelects(){
const cSel=$("#customerSelect");
cSel.empty().append(new Option("", "", true, true));
customers.forEach(c=>{
cSel.append(new Option(`${c.branch_code} - ${c.customer_name} (${c.province})`,c.branch_code));
});
cSel.select2({placeholder:"ค้นหาลูกค้า",allowClear:true});
cSel.on("change",function(){
const val=$(this).val();
const found=customers.find(c=>c.branch_code===val);
if(found){
$("#branchCode").val(found.branch_code);
$("#customerName").val(found.customer_name);
$("#province").val(found.province);
}
});

const dSel=$("#driverSelect");
dSel.empty().append(new Option("", "", true, true));
drivers.forEach(d=>{
dSel.append(new Option(`${d.plate} - ${d.driver_name}`,d.plate));
});
dSel.select2({placeholder:"ค้นหาคนขับ",allowClear:true});
dSel.on("change",function(){
const val=$(this).val();
const found=drivers.find(d=>d.plate===val);
if(found){
$("#driverPlate").val(found.plate);
$("#driverName").val(found.driver_name);
$("#driverPhone").val(found.phone);
}
});
}

function renderLabels(d){
const container=byId("labels");
container.innerHTML="";
if(d.total_boxes<=0)return;
for(let i=1;i<=d.total_boxes;i++){
container.innerHTML+=`
<div class="label">
<div class="lay">
<div class="store">${d.customer_name}</div>
<div class="right"><div class="cap">รหัสสาขา:</div><div class="code">${d.branch_code}</div></div>
<div class="count">${i}/${d.total_boxes}</div>
<div class="prov">จว.: ${d.province}</div>
</div></div>`;
}
}

byId("btnGen").onclick=()=>{
renderLabels({
customer_name:byId("customerName").value,
branch_code:byId("branchCode").value,
province:byId("province").value,
total_boxes:Number(byId("totalBoxes").value||0)
});
};

byId("btnPrint").onclick=async()=>{
try{
setStatus(false,"กำลังบันทึก...");
const d={
branch_code:byId("branchCode").value,
customer_name:byId("customerName").value,
province:byId("province").value,
total_boxes:byId("totalBoxes").value,
driver_plate:byId("driverPlate").value,
driver_name:byId("driverName").value,
driver_phone:byId("driverPhone").value,
action:byId("action").value,
note:byId("note").value
};
await apiGet("log",d);
setStatus(true,"บันทึกสำเร็จ");
renderLabels({...d,total_boxes:Number(d.total_boxes)});
window.print();
}catch(e){
setStatus(false,"ผิดพลาด");
alert(e.message);
}
};

byId("btnClear").onclick=()=>{
$("#customerSelect").val(null).trigger("change");
$("#driverSelect").val(null).trigger("change");
byId("totalBoxes").value=0;
byId("note").value="";
byId("labels").innerHTML="";
};

(async function init(){
try{
setStatus(false,"โหลดข้อมูล...");
customers=(await apiGet("customers")).items||[];
drivers=(await apiGet("drivers")).items||[];
initSelects();
setStatus(true,"พร้อมใช้งาน");
}catch(e){
setStatus(false,"โหลดข้อมูลไม่สำเร็จ");
alert(e.message);
}
})();
</script>
</body>
</html>
